name: EKTC Scraper
on:
  schedule:
    - cron: "*/15 * * * *" # Каждые 15 минут
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup and Install
        run: |
          # Создаем package.json принудительно, чтобы точно был нужный тип и зависимости
          echo '{"type":"module","dependencies":{"playwright":"1.49.0"}}' > package.json
          npm install
          npx playwright install --with-deps chromium

      - name: Restore state.json
        env:
          # Если ваш секрет - это обычный текст JSON, используем его напрямую
          STATE_JSON: ${{ secrets.STATE_JSON }}
        run: |
          if [ -z "$STATE_JSON" ]; then
            echo "STATE_JSON is empty!"
          else
            echo "$STATE_JSON" > state.json
            echo "state.json created"
          fi

      - name: Run scraper
        env:
          SITE_BASE: ${{ secrets.SITE_BASE }}
          ADMIN_PASS: ${{ secrets.ADMIN_PASS }}
        run: node scrape.js
